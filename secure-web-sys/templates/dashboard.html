<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <!-- Bootstrap CSS for layout and cards -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #e8f5ee; color: #222; }
        .card { margin-bottom: 1rem; transition: box-shadow 0.3s, transform 0.3s, opacity 0.8s, top 0.8s; opacity: 0; top: 30px; background: #fff; border-radius: 16px; border: none; color: #222; }
        .card.fade-in { opacity: 1; top: 0; }
        .dashboard-title { margin: 2rem 0 1rem 0; color: #005a30; text-shadow: none; }
        .card-header { background: #fff !important; color: #005a30 !important; border-radius: 16px 16px 0 0; border: none; border-bottom: 1px solid #e0e0e0; letter-spacing: 1px; font-weight: bold; }
        .table { background: #fff; border-radius: 0 0 16px 16px; overflow: hidden; color: #222; }
        .table-striped > tbody > tr:nth-of-type(odd) { background-color: #f3f9f6; }
        .table-hover > tbody > tr:hover { background-color: #d1f5e0; color: #005a30; }
        .table thead { background: #e8f5ee; color: #005a30; border-bottom: 2px solid #005a30; }
        .table th, .table td { vertical-align: middle; }
        .rounded { border-radius: 16px !important; }
        .list-group-item { background: #fff; color: #222; border: none; }
        .btn-primary { background: #005a30; border: none; color: #fff; }
        .btn-primary:hover, .btn-primary:focus { background: #007a4d; color: #fff; }
        .btn-secondary { background: #e8f5ee; border: none; color: #005a30; }
        .btn-secondary:hover, .btn-secondary:focus { background: #d1f5e0; color: #005a30; }
        .btn-success { background: #22c55e; border: none; color: #fff; }
        .btn-success:hover, .btn-success:focus { background: #198754; color: #fff; }
        .btn-danger { background: #ef4444; border: none; color: #fff; }
        .btn-danger:hover, .btn-danger:focus { background: #b91c1c; color: #fff; }
        .btn-warning { background: #f59e42; border: none; color: #fff; }
        .btn-warning:hover, .btn-warning:focus { background: #d97706; color: #fff; }
        .btn-group .btn { margin-right: 0.25rem; }
        .btn-group .btn:last-child { margin-right: 0; }
        .avatar-initials { background: #005a30; color: #fff; text-shadow: none; }
        .avatar-admin { background: #22c55e !important; color: #fff !important; }
        .avatar-locked { background: #ef4444 !important; color: #fff !important; }
        .sticky-top { position: sticky; top: 0; z-index: 2; }
        /* Card hover effect */
        .card:hover { box-shadow: 0 0 24px 0 #005a30; transform: translateY(-4px) scale(1.02); }
        /* Table row fade-in and hover */
        tr { transition: background 0.3s, color 0.3s, opacity 0.8s, top 0.8s; opacity: 0; top: 30px; }
        tr.fade-in { opacity: 1; top: 0; }
        tr:hover { background: #d1f5e0 !important; color: #005a30; }
        .dark-toggle { display: none; }
    </style>
</head>
<body>
<!-- Dark mode toggle button -->
<button class="btn btn-outline-secondary dark-toggle" id="darkModeToggle" title="Toggle dark mode">
    üåô
</button>
<div class="container">
    <h1 class="dashboard-title text-center">Admin Dashboard</h1>
    <!-- Summary Cards -->
    <div class="row text-center">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <h2 id="totalUsers">{{ total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Active Today</h5>
                    <h2 id="activeToday">{{ active_today }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Locked Accounts</h5>
                    <h2 id="lockedAccounts">{{ locked_accounts }}</h2>
                </div>
            </div>
        </div>
    </div>
    <!-- Charts -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Login Attempts (Last 7 Days)</h5>
                    <canvas id="loginLineChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Success vs Failure</h5>
                    <canvas id="loginPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- User Table and Activity Feed -->
    <div class="row">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-body p-0">
                    <div class="card-header bg-primary text-white fw-bold fs-5">User List</div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle mb-0 rounded" id="userTable" style="overflow:hidden;">
                            <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:48px;"></th>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Admin</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for user in user_list %}
                            <tr>
                                <td>
                                    <div class="rounded-circle avatar-initials {% if user[3] == 1 %}avatar-admin{% endif %}{% if user[1] in locked_users %} avatar-locked{% endif %} d-flex align-items-center justify-content-center" style="width:36px;height:36px;font-weight:bold;font-size:1.1rem;">
                                        {{ user[1][0]|upper }}
                                    </div>
                                </td>
                                <td>{{ user[0] }}</td>
                                <td>{{ user[1] }}</td>
                                <td>{{ user[2] }}</td>
                                <td>{% if user[3] == 1 %}‚úîÔ∏è{% else %}‚ùå{% endif %}</td>
                                <td>
                                    {% if user[1] != session['username'] %}
                                    <div class="btn-group" role="group">
                                        {% if user[1] in locked_users %}
                                        <button class="btn btn-sm btn-success unlock-btn" data-bs-toggle="tooltip" title="Unlock user" data-username="{{ user[1] }}"><i class="bi bi-unlock"></i></button>
                                        {% else %}
                                        <button class="btn btn-sm btn-danger lock-btn" data-bs-toggle="tooltip" title="Lock user" data-username="{{ user[1] }}"><i class="bi bi-lock"></i></button>
                                        {% endif %}
                                        {% if user[3] == 1 %}
                                        <button class="btn btn-sm btn-secondary demote-btn" data-bs-toggle="tooltip" title="Remove admin" data-username="{{ user[1] }}"><i class="bi bi-person-dash"></i></button>
                                        {% else %}
                                        <button class="btn btn-sm btn-primary promote-btn" data-bs-toggle="tooltip" title="Make admin" data-username="{{ user[1] }}"><i class="bi bi-person-plus"></i></button>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Recent Login Activity</h5>
                    <ul class="list-group" id="logEntries">
                        {% for entry in log_entries %}
                        <li class="list-group-item">{{ entry|e }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-4 mb-4">
        <a href="/" class="btn btn-secondary">‚¨Ö Back to Home</a>
    </div>
</div>
<!-- Drilldown Modal -->
<div class="modal fade" id="drilldownModal" tabindex="-1" aria-labelledby="drilldownModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="drilldownModalLabel">Login Events for <span id="drilldownDate"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group" id="drilldownList"></ul>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Make the current username available to JS
const currentUsername = {{ session['username']|default('null')|tojson|safe }};
// Dark mode logic
const darkModeToggle = document.getElementById('darkModeToggle');
function setDarkMode(on) {
    if (on) {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '‚òÄÔ∏è';
    } else {
        document.body.classList.remove('dark-mode');
        darkModeToggle.textContent = 'üåô';
    }
    localStorage.setItem('darkMode', on ? '1' : '0');
}
darkModeToggle.addEventListener('click', function() {
    setDarkMode(!document.body.classList.contains('dark-mode'));
});
// On load, set mode from localStorage
if (localStorage.getItem('darkMode') === '1') {
    setDarkMode(true);
} else {
    setDarkMode(false);
}

// Initial data from server-rendered context
const initialLoginStats = {{ login_stats|tojson|safe }};
const initialSuccessCount = {{ success_count|default(0) }};
const initialFailureCount = {{ failure_count|default(0) }};

// Line Chart
const lineCtx = document.getElementById('loginLineChart').getContext('2d');
const lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: initialLoginStats.map(item => item.date),
        datasets: [
            {
                label: 'Success',
                data: initialLoginStats.map(item => item.success_count),
                borderColor: '#005a30',
                backgroundColor: 'rgba(0,90,48,0.08)',
                fill: true
            },
            {
                label: 'Failure',
                data: initialLoginStats.map(item => item.failure_count),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239,68,68,0.08)',
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'top', labels: { color: '#005a30' } } },
        onClick: null // Initialize onClick to null
    }
});

// Pie Chart
const pieCtx = document.getElementById('loginPieChart').getContext('2d');
const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: ['Success', 'Failure'],
        datasets: [{
            data: [initialSuccessCount, initialFailureCount],
            backgroundColor: ['#005a30', '#ef4444']
        }]
    },
    options: {
        plugins: { legend: { labels: { color: '#005a30' } } }
    }
});

// Live update function
function updateDashboard() {
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            // Update summary cards
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('activeToday').textContent = data.active_today;
            document.getElementById('lockedAccounts').textContent = data.locked_accounts;

            // Update line chart
            lineChart.data.labels = data.login_stats.map(item => item.date);
            lineChart.data.datasets[0].data = data.login_stats.map(item => item.success_count);
            lineChart.data.datasets[1].data = data.login_stats.map(item => item.failure_count);
            lineChart.update();

            // Update pie chart
            pieChart.data.datasets[0].data = [data.success_count, data.failure_count];
            pieChart.update();

            // Update user table (admin only)
            if (data.is_admin) {
                const userTableBody = document.querySelector('#userTable tbody');
                userTableBody.innerHTML = '';
                const lockedUsers = data.locked_users || [];
                data.user_list.forEach((user, i) => {
                    const isSelf = user[1] === currentUsername;
                    let actions = '';
                    if (!isSelf) {
                        actions += '<div class="btn-group" role="group">';
                        if (lockedUsers.includes(user[1])) {
                            actions += `<button class="btn btn-sm btn-success unlock-btn" data-bs-toggle="tooltip" title="Unlock user" data-username="${user[1]}"><i class="bi bi-unlock"></i></button>`;
                        } else {
                            actions += `<button class="btn btn-sm btn-danger lock-btn" data-bs-toggle="tooltip" title="Lock user" data-username="${user[1]}"><i class="bi bi-lock"></i></button>`;
                        }
                        if (user[3] == 1) {
                            actions += `<button class="btn btn-sm btn-secondary demote-btn" data-bs-toggle="tooltip" title="Remove admin" data-username="${user[1]}"><i class="bi bi-person-dash"></i></button>`;
                        } else {
                            actions += `<button class="btn btn-sm btn-primary promote-btn" data-bs-toggle="tooltip" title="Make admin" data-username="${user[1]}"><i class="bi bi-person-plus"></i></button>`;
                        }
                        actions += '</div>';
                    }
                    const tr = document.createElement('tr');
                    const avatarClass = `rounded-circle avatar-initials d-flex align-items-center justify-content-center${user[3] == 1 ? ' avatar-admin' : ''}${lockedUsers.includes(user[1]) ? ' avatar-locked' : ''}`;
                    tr.innerHTML = `
                        <td><div class='${avatarClass}' style='width:36px;height:36px;font-weight:bold;font-size:1.1rem;'>${user[1][0].toUpperCase()}</div></td>
                        <td>${user[0]}</td>
                        <td>${user[1]}</td>
                        <td>${user[2]}</td>
                        <td>${user[3] == 1 ? '‚úîÔ∏è' : '‚ùå'}</td>
                        <td>${actions}</td>`;
                    userTableBody.appendChild(tr);
                    setTimeout(() => tr.classList.add('fade-in'), 100 + i * 60);
                });
                attachAdminActionHandlers();
                // Enable tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                  return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            // Update recent log entries
            const logEntriesList = document.getElementById('logEntries');
            logEntriesList.innerHTML = '';
            data.log_entries.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = entry;
                logEntriesList.appendChild(li);
            });
        });
}
setInterval(updateDashboard, 5000); // Update every 5 seconds

// Drilldown on line chart
lineChart.options.onClick = function(evt, elements) {
    if (elements && elements.length > 0) {
        const idx = elements[0].index;
        const date = lineChart.data.labels[idx];
        document.getElementById('drilldownDate').textContent = date;
        // Fetch login events for this day
        fetch(`/api/logins-for-day?date=${date}`)
            .then(response => response.json())
            .then(entries => {
                const list = document.getElementById('drilldownList');
                list.innerHTML = '';
                if (entries.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = 'No login events for this day.';
                    list.appendChild(li);
                } else {
                    entries.forEach(entry => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = entry;
                        list.appendChild(li);
                    });
                }
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('drilldownModal'));
                modal.show();
            });
    }
};

// Helper to check if a user is locked (from the dashboard data)
function isUserLocked(username, lockedAccounts, userList) {
    // This is a placeholder; you may want to pass locked users from the backend for accuracy
    // For now, always show both lock/unlock buttons
    return false;
}
// Attach admin action handlers (call after table is rendered)
function attachAdminActionHandlers() {
    document.querySelectorAll('.lock-btn').forEach(btn => {
        btn.onclick = function() {
            fetch('/api/lock-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: btn.dataset.username })
            }).then(() => updateDashboard());
        };
    });
    document.querySelectorAll('.unlock-btn').forEach(btn => {
        btn.onclick = function() {
            fetch('/api/unlock-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: btn.dataset.username })
            }).then(() => updateDashboard());
        };
    });
    document.querySelectorAll('.promote-btn').forEach(btn => {
        btn.onclick = function() {
            fetch('/api/set-admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: btn.dataset.username, is_admin: true })
            }).then(() => updateDashboard());
        };
    });
    document.querySelectorAll('.demote-btn').forEach(btn => {
        btn.onclick = function() {
            fetch('/api/set-admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: btn.dataset.username, is_admin: false })
            }).then(() => updateDashboard());
        };
    });
}

// Fade-in animation for cards and table rows
window.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.card').forEach(function(card, i) {
        setTimeout(() => card.classList.add('fade-in'), 100 + i * 120);
    });
    document.querySelectorAll('tr').forEach(function(row, i) {
        setTimeout(() => row.classList.add('fade-in'), 400 + i * 60);
    });
    attachAdminActionHandlers();
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
</body>
</html>
