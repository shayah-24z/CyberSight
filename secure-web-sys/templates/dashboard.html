<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <!-- Bootstrap CSS for layout and cards -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f8f9fa; }
        .card { margin-bottom: 1rem; }
        .dashboard-title { margin: 2rem 0 1rem 0; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="dashboard-title text-center">Admin Dashboard</h1>
    <!-- Summary Cards -->
    <div class="row text-center">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <h2 id="totalUsers">{{ total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Active Today</h5>
                    <h2 id="activeToday">{{ active_today }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Locked Accounts</h5>
                    <h2 id="lockedAccounts">{{ locked_accounts }}</h2>
                </div>
            </div>
        </div>
    </div>
    <!-- Charts -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Login Attempts (Last 7 Days)</h5>
                    <canvas id="loginLineChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Success vs Failure</h5>
                    <canvas id="loginPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- User Table and Activity Feed -->
    <div class="row">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">User List</h5>
                    <table class="table table-striped" id="userTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Admin</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in user_list %}
                        <tr>
                            <td>{{ user[0] }}</td>
                            <td>{{ user[1] }}</td>
                            <td>{{ user[2] }}</td>
                            <td>{% if user[3] == 1 %}✔️{% else %}❌{% endif %}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Recent Login Activity</h5>
                    <ul class="list-group" id="logEntries">
                        {% for entry in log_entries %}
                        <li class="list-group-item">{{ entry|e }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-4 mb-4">
        <a href="/" class="btn btn-secondary">⬅ Back to Home</a>
    </div>
</div>
<script>
// Initial data from server-rendered context
const initialLoginStats = {{ login_stats|tojson|safe }};
const initialSuccessCount = {{ success_count|default(0) }};
const initialFailureCount = {{ failure_count|default(0) }};

// Line Chart
const lineCtx = document.getElementById('loginLineChart').getContext('2d');
const lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: initialLoginStats.map(item => item.date),
        datasets: [
            {
                label: 'Success',
                data: initialLoginStats.map(item => item.success_count),
                borderColor: 'green',
                backgroundColor: 'rgba(0,255,0,0.1)',
                fill: true
            },
            {
                label: 'Failure',
                data: initialLoginStats.map(item => item.failure_count),
                borderColor: 'red',
                backgroundColor: 'rgba(255,0,0,0.1)',
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'top' } }
    }
});

// Pie Chart
const pieCtx = document.getElementById('loginPieChart').getContext('2d');
const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: ['Success', 'Failure'],
        datasets: [{
            data: [initialSuccessCount, initialFailureCount],
            backgroundColor: ['green', 'red']
        }]
    }
});

// Live update function
function updateDashboard() {
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            // Update summary cards
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('activeToday').textContent = data.active_today;
            document.getElementById('lockedAccounts').textContent = data.locked_accounts;

            // Update line chart
            lineChart.data.labels = data.login_stats.map(item => item.date);
            lineChart.data.datasets[0].data = data.login_stats.map(item => item.success_count);
            lineChart.data.datasets[1].data = data.login_stats.map(item => item.failure_count);
            lineChart.update();

            // Update pie chart
            pieChart.data.datasets[0].data = [data.success_count, data.failure_count];
            pieChart.update();

            // Update user table (admin only)
            if (data.is_admin) {
                const userTableBody = document.querySelector('#userTable tbody');
                userTableBody.innerHTML = '';
                data.user_list.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${user[0]}</td><td>${user[1]}</td><td>${user[2]}</td><td>${user[3] == 1 ? '✔️' : '❌'}</td>`;
                    userTableBody.appendChild(tr);
                });
            }

            // Optionally, update recent log entries if you add them to the API in the future
            // document.getElementById('logEntries').innerHTML = ...
            // Update recent log entries
            const logEntriesList = document.getElementById('logEntries');
            logEntriesList.innerHTML = '';
            data.log_entries.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = entry;
                logEntriesList.appendChild(li);
            });
        });
}
setInterval(updateDashboard, 5000); // Update every 5 seconds
</script>
</body>
</html>
